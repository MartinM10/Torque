{% extends 'sessions_list.html' %}
{% load static %}
{% block map %}

    <div class="container-fluid text-center" style="height: max-content">
        <div class="col-sm-8 text-left" style="width: 60%; margin-left: 10px; height: 60vh; margin-top: 10px" id="map">

        </div>

        {% if summary %}

            <div class="col-sm-2 sidenav">
                <h4><b>Session summary</b></h4>
                <hr/>
                {% for key, value in summary.items %}
                    {% if value %}
                        <p>{{ key }}: {{ value }}</p>
                    {% endif %}
                {% endfor %}
            </div>

        {% endif %}

    </div>

    <script type="text/javascript">
        // Make basemap
        const map = new L.Map('map', { center: new L.LatLng(36.6301208, -4.497461), zoom: 11});
        const osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

        map.addLayer(osm);

        function onEachFeature(feature, layer) {
            if (feature.properties) {
                var popupContent = '<div style=text-align:center><strong>';

                if (feature.properties.email) {
                    popupContent+= feature.properties.email + '<br/>'
                    //popupContent+= feature.properties.date + '<br/>'
                }

                if (feature.properties.date) {
                    popupContent+= feature.properties.date + '<br/>'
                }
                popupContent+='</strong></div><hr>';

                for (var p in feature.properties) {
                    if ((
                        feature.properties[p] != feature.properties.email  &&
                        feature.properties[p] != feature.properties.date
                        // feature.properties[p] == feature.properties.CO2_Average ||
                        // feature.properties[p] === feature.properties.CO2_Instantaneous ||
                        // feature.properties[p] === feature.properties.Litres_Per_100_Kilometer
                        ) &&
                        feature.properties[p] != null
                        ) {
                            popupContent += '<tr><td>' + p + '</td><td>: '+ feature.properties[p] + '</td></tr><br/>';
                        }
                }
                popupContent += '</table>';
                layer.bindPopup(popupContent);
                    /*
                    if(feature.properties.gps_accuracy) {
                        layer.bindPopup.append("<tr><td>Speed (GPS): " + feature.properties.speed_GPS);
                    }

                    if(feature.properties.CO2_Average) {
                        layer.bindPopup.append("<tr><td>CO₂ in g/km (Average):: " + feature.properties.CO2_Average);
                    }

                    if(feature.properties.CO2_Instantaneous) {
                        layer.bindPopup.append("<tr><td>CO₂ in g/km (Instantaneous): " + feature.properties.CO2_Instantaneous);
                    }

                    if(feature.properties.Litres_Per_100_Kilometer) {
                        layer.bindPopup.append("<hr><table><tr><td>Litres Per 100 Kilometer: " + feature.properties.Litres_Per_100_Kilometer + "</td></tr>");
                    }
                    */
            }
        }

        function createCustomIcon (feature, latlng) {
            var myIcon = L.icon({
                iconUrl: 'https://cdn.icon-icons.com/icons2/1102/PNG/128/1485969928-17-location_78896.png',
                //shadowUrl: 'my-icon.png',
                iconSize:     [25, 25], // width and height of the image in pixels
                shadowSize:   [35, 20], // width, height of optional shadow image
                iconAnchor:   [12, 12], // point of the icon which will correspond to marker's location
                shadowAnchor: [12, 6],  // anchor point of the shadow. should be offset
                popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
              })
              return L.marker(latlng, { icon: myIcon })
            }

        var myLayerOptions = {
            onEachFeature: onEachFeature,
            pointToLayer: createCustomIcon
        }

        L.geoJSON({{ data|safe }}, myLayerOptions).addTo(map);

        // var sessions = L.layerGroup([]);
        // sessions.addTo(map)
        // map.addLayer(sessions)
    </script>

{% endblock map %}

{% include 'sessions_list.html' %}
